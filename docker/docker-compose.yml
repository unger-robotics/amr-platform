# AMR Docker Stack
# Raspberry Pi OS + ROS 2 Jazzy

services:
  # ============================================
  # ROS 2 Perception Stack
  # ============================================
  perception:
    build:
      context: ./perception
      dockerfile: Dockerfile
    image: amr_perception:jazzy
    container_name: amr_perception
    hostname: amr_perception
    network_mode: host
    privileged: true
    restart: unless-stopped
    
    volumes:
      - /dev:/dev
      - /run/udev:/run/udev:ro
      - ./perception/src:/ros_ws/src
      - ./config:/ros_ws/config
      - ./maps:/ros_ws/maps
      - ./launch:/ros_ws/launch
      - /var/run/camera:/var/run/camera
      
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - RCUTILS_COLORIZED_OUTPUT=1
      
    devices:
      - /dev/ttyUSB0:/dev/ttyUSB0
      - /dev/video0:/dev/video0
      - /dev/hailo0:/dev/hailo0
      
    command: >
      bash -c "
        source /opt/ros/jazzy/setup.bash &&
        if [ -f /ros_ws/install/setup.bash ]; then
          source /ros_ws/install/setup.bash
        fi &&
        echo 'ROS 2 Jazzy ready.' &&
        sleep infinity
      "

  # ============================================
  # Serial Bridge (ersetzt micro-ROS Agent)
  # ============================================
  serial_bridge:
    image: ros:jazzy-ros-base
    container_name: amr_serial_bridge
    hostname: amr_serial_bridge
    network_mode: host
    privileged: true
    restart: unless-stopped
    
    volumes:
      - ../ros2_ws/src/amr_serial_bridge:/ros2_ws/src/amr_serial_bridge:ro
      - /dev:/dev
      
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      
    devices:
      - /dev/ttyACM0:/dev/ttyACM0
      
    command: >
      bash -c "
        apt-get update && apt-get install -y python3-pip python3-serial &&
        source /opt/ros/jazzy/setup.bash &&
        cd /ros2_ws &&
        colcon build --packages-select amr_serial_bridge --symlink-install &&
        source install/setup.bash &&
        echo 'Serial Bridge starting...' &&
        ros2 run amr_serial_bridge serial_bridge
      "
    
    depends_on:
      - perception
