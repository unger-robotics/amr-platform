# AMR Docker Stack
# Raspberry Pi OS + ROS 2 Humble/Jazzy
#
# HINWEIS: micro-ROS Agent läuft als systemd Service (microros-agent.service)
# Serial-Bridge ist nicht mehr erforderlich.

services:
  # ============================================
  # ROS 2 Perception Stack
  # ============================================
  perception:
    build:
      context: ./perception
      dockerfile: Dockerfile
    image: amr_perception:jazzy
    container_name: amr_perception
    hostname: amr_perception
    network_mode: host
    privileged: true
    restart: unless-stopped

    volumes:
      - /dev:/dev
      - /run/udev:/run/udev:ro
      - ./perception/src:/ros_ws/src
      - ./config:/ros_ws/config
      - ./maps:/ros_ws/maps
      - ./launch:/ros_ws/launch
      - /var/run/camera:/var/run/camera

    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - RCUTILS_COLORIZED_OUTPUT=1

    devices:
      - /dev/ttyUSB0:/dev/ttyUSB0
      - /dev/video0:/dev/video0
      - /dev/hailo0:/dev/hailo0

    command: >
      bash -c "
        source /opt/ros/jazzy/setup.bash &&
        if [ -f /ros_ws/install/setup.bash ]; then
          source /ros_ws/install/setup.bash
        fi &&
        echo 'ROS 2 Jazzy ready.' &&
        sleep infinity
      "

  # ============================================
  # Teleop (optional - für Tastatursteuerung)
  # ============================================
  teleop:
    image: ros:humble
    container_name: amr_teleop
    network_mode: host
    stdin_open: true
    tty: true
    profiles:
      - teleop  # Nur mit: docker compose --profile teleop up

    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp

    command: >
      bash -c "
        apt-get update && apt-get install -y ros-humble-teleop-twist-keyboard &&
        source /opt/ros/humble/setup.bash &&
        ros2 run teleop_twist_keyboard teleop_twist_keyboard
      "

# ============================================
# ARCHIV: Serial-Bridge (ersetzt durch micro-ROS)
# ============================================
# Der serial_bridge Service wurde durch native micro-ROS ersetzt.
# micro-ROS Agent läuft als systemd Service:
#   sudo systemctl status microros-agent
#
# Falls Rollback nötig:
#   1. systemctl disable microros-agent
#   2. serial_bridge Service unten einkommentieren
#
#  serial_bridge:
#    image: ros:jazzy-ros-base
#    container_name: amr_serial_bridge
#    hostname: amr_serial_bridge
#    network_mode: host
#    privileged: true
#    restart: unless-stopped
#    volumes:
#      - ../ros2_ws/src/amr_serial_bridge:/ros2_ws/src/amr_serial_bridge:ro
#      - /dev:/dev
#    environment:
#      - ROS_DOMAIN_ID=0
#      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
#    devices:
#      - /dev/ttyACM0:/dev/ttyACM0
#    command: >
#      bash -c "
#        apt-get update && apt-get install -y python3-pip python3-serial &&
#        source /opt/ros/jazzy/setup.bash &&
#        cd /ros2_ws &&
#        colcon build --packages-select amr_serial_bridge --symlink-install &&
#        source install/setup.bash &&
#        ros2 run amr_serial_bridge serial_bridge
#      "
